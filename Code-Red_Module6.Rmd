---
title: "Code-Red_module6"
author: "Liz Aspirino, Tingwei Hu, James Kim, Justin Lau"
date: "2022-11-02"
output: html_document
bibliography: BIOL3140.bib
nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, packages, include=FALSE}
library(tidyverse)
library(Momocs)
library(knitr)
library(vroom)
library(ape)
```
#Introduction
Lepidoptera describes the order of insects that is compromised of over 160,000 species of butterflies and moths. The Lepidptera occupy various ecological niche in different geographical locations using their ability to fly to traverse their environment. Their wings can be separated into their forewings and hindwings which plays a different role in the Lepidoptera's ability to fly. Previous studies have found that if the hindwings were to be removed, the lepidoptera is able to fly but their ability for linear and turning acceleration is greatly hindered (Jantzen and Eisner 2008). It can be then said that the wing shape of the various Leidoptera species is the result of environmental pressure that selected for shapes of the wings that allows for better flight maneuverability. This is supported by various studies that suggested that the selection of forewing shape is determined by its ability to fly while the hindwing shape id determined by several possible neutral selections such as sexual selection to predator avoidance (Sourakov 2013, Barber et al. 2015, Willmott et al. 2017, Rubin et al. 2018, Chazot et al. 2016). However, it is not known whether then the evolution of hindwing and forewings shape have occured independently or if a correlation could be found. The goal of this study is to determine the evolutionary correlation between the hindwing and forewing shape by running a comparative phylogenetic analysis on the wing shape data of more than 200 Leidoptera species to determine if any significant relationship in evolutionary shift can be found.

#Methods
The outline-base shape analysis was utilized through the elliptical Fourier analysis (EFA).The data of the Lepidoptera forewings and hindswings were visualized using principle components analysis(PCA) and EFA using functions included in the package "Momocs." The initial outlines combined forewing and hindwing outline for each species so it was separated via their file name, made into equal scale and superimposed onto each other for better analysis of their shape without factoring in the size of wings. After separating the wings into their shapes and equalizing their sizes, the PCA data was visualized to determine the distribution of morphoshape of the wings of the different species.
(insert relevant coding procedure here)

To prepare the comparative analysis on the PCA data the phylogenetic tree was loaded positioned upper left. The file names of each species were also identified using the identifier data provided by Prof. Kenaley. The PC data was added to the identified species data accordingly. The phylogeny tree was modified to only include the species that were identified and had a PCA data. From here, the forewing and hindwing PC1 and PC2 were separated in different variable under the Brownian Motion.
(insert relevant coding procedure here)

To determine the evolutionary rate, "RRphylo" package was used to determine the rate of evolution based on wing shape and from there, any statistically significant shift in shape evolution based on the Lepdioptera's clades were identified. The rate of the significant evolutionary shift was identified along with the name of clades.
(insert relevant coding procedure here)

The phylogenetic independent contrast was performed on the PC datas to separate the original tip data independent of each other. The PC values of forewing and hindwing data were then compared via linear model and analyzed to see if statistically significant value could be found.
(insert relevant coding procedure here)

*note from James: this is obviously very rough methods section. I'll try to refine it over the course of the next two days.


```{r, preprocessing, results='hide'}
#read files and make matrix
f <- list.files("class_out_data",pattern=".txt|.csv",full.names = TRUE)
out <- read_delim(f[1],delim="\t") %>% 
  as.matrix()
#transform matrix in momocs outline
out %>% 
  list() %>% 
  Out() %>% 
  coo_flipx() %>% 
  stack()
```

```{r, loading files & more preprocessing, results='hide'}
#make a large df with vroom
out.df <- vroom::vroom(f, id = "filename")
#add wing info
out.df <- out.df %>% 
  mutate(wing=gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(filename))) %>% 
  na.omit()
#make list
outs.l <- sapply(f,function(x) out.df %>% filter(filename==x) %>% select(X,Y) %>% as.matrix)
#extract wing info
wings <- gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(names(outs.l)))
outs <-  outs.l %>% 
  Out(fac=list(wing=wings)) %>% 
  coo_flipx() %>% 
  stack() #visualize both wings uncorreced for size
```

```{r, Separate and Procrustes transform both wings}
#separate outlines by fore&hind wing
forewings <- outs %>% 
  filter(wing=="forewing")

hindwings <- outs %>% 
  filter(wing=="hindwing")

#Procrustes, align
fore.min <- forewings %>% 
  coo_nb() %>% 
  min()
forewings %>%
  coo_interpolate(fore.min) %>% 
  fgProcrustes() %>% 
  stack() #visualize forewings
hind.min <- hindwings %>% 
  coo_nb() %>% 
  min()
hindwings %>% 
   coo_interpolate(hind.min) %>% 
  coo_slide(id=1) %>% 
   coo_align()  %>%
  fgProcrustes() %>%
  stack() #visualize hindwings
```
```{r,}

```

#Results

#Discussion

#Author Contributions

#References