---
title: "Code-Red_module6"
author: "Liz Asprinio, Tingwei Hu, James Kim, Justin Lau"
date: "2022-11-02"
output: html_document
bibliography: BIOL3140.bib
nocite: '@*'
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, packages, include=FALSE}
library(tidyverse)
library(Momocs)
library(knitr)
library(vroom)
library(ape)
```

#Introduction

The Lepidoptera are an order of insects compromised of nearly 160,000 species of butterflies and moths.
They have both forewings and hindwings, each playing roles in functions such as flying and attracting mates.
Previous studies have found that if the hindwings of a moth or butterfly are removed, the insect can fly but its ability for linear and turning acceleration is greatly hindered (@jantzen2008hindwings).
Based on these findings, it can be concluded that Lepidoptera hindwing shape is due to selection for improved flight maneuverability.
Further studies suggest that selection for forewing shape is determined by flight ability, while selection for hindwing shape is determined by several possibilities, such as neutral selection, sexual selection, and predator avoidance (Sourakov 2013, Barber et al. 2015, Willmott et al. 2017, Rubin et al. 2018, Chazot et al. 2016).
While these studies show that Lepidoptera forewings and hindwings have evolved different functions, there is still much that is not known about their evolutionary history.
The purpose of this study is to determine whether Lepidoptera forewings and hindwings vary in their evolutionary rates, if different lineages have evolved at significantly different rates, and if forewing and hindwing shapes are correlated.
This will be done by running a comparative phylogenetic analysis on the wing shape data of more than 200 species of Lepidoptera, using a phylogenetic tree provided by @kawahara2019phylogenomics.

#Methods

The outline-base shape analysis was analyzed using Elliptical Fourier analysis (EFA).The data of the Lepidoptera forewings and hindwings were visualized using principle components analysis(PCA) and EFA using functions included in the package "Momocs." The initial outlines combined forewing and hindwing outline for each species so it was separated via their file name, made into equal scale and superimposed onto each other for better analysis of their shape without factoring in the size of wings.
After separating the wings into their shapes and equalizing their sizes, the PCA data was visualized to determine the distribution of morphoshape of the wings of the different species.
(insert relevant coding procedure here)

To prepare the comparative analysis on the PCA data the phylogenetic tree was loaded positioned upper left.
The file names of each species were also identified using the identifier data provided by Prof. Kenaley.
The PC data was added to the identified species data accordingly.
The phylogeny  was modified to only include the species that were identified and had a PCA data.
From here, the forewing and hindwing PC1 and PC2 were separated in different variable under the Brownian Motion.
(insert relevant coding procedure here)

To determine the evolutionary rate, "RRphylo" package was used to determine the rate of evolution based on wing shape and from there, any statistically significant shift in shape evolution based on the Lepdioptera's clades were identified.
The rate of the significant evolutionary shift was identified along with the name of clades.
(insert relevant coding procedure here)

The phylogenetic independent contrast was performed on the PC datas to separate the original tip data independent of each other.
The PC values of forewing and hindwing data were then compared via linear model and analyzed to see if statistically significant value could be found.
(insert relevant coding procedure here)

\*note from James: this is obviously very rough methods section.
I'll try to refine it over the course of the next two days.

#Results

Shape Analysis

```{r, preprocessing, results='hide'}

f <- list.files("class_out_data",pattern=".txt|.csv",full.names = TRUE)
out <- read_delim(f[1],delim="\t") %>% 
  as.matrix()
#transform matrix in momocs outline
out %>% 
  list() %>% 
  Out() %>% 
  coo_flipx() %>% 
  stack()
```

```{r, loading files & more preprocessing, results='hide'}
#make a large df with vroom
out.df <- vroom::vroom(f, id = "filename")
#add wing info
out.df <- out.df %>% 
  mutate(wing=gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(filename))) %>% 
  na.omit()
#make list
outs.l <- sapply(f,function(x) out.df %>% filter(filename==x) %>% select(X,Y) %>% as.matrix)
#extract wing info
wings <- gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(names(outs.l)))
outs <-  outs.l %>% 
  Out(fac=list(wing=wings)) %>% 
  coo_flipx() %>% 
  stack() #visualize both wings uncorreced for size
```

```{r, Separate and Procrustes transform both wings}
#separate outlines by fore&hind wing
forewings <- outs %>% 
  filter(wing =="forewing")

hindwings <- outs %>% 
  filter(wing =="hindwing")

#Procrustes, align
fore.min <- forewings %>% 
  coo_nb() %>% 
  min()
forewings %>%
  coo_interpolate(fore.min) %>% 
  fgProcrustes() %>% 
  stack() #visualize forewings
hind.min <- hindwings %>% 
  coo_nb() %>% 
  min()
hindwings %>% 
   coo_interpolate(hind.min) %>% 
  coo_slide(id=1) %>% 
   coo_align()  %>%
  fgProcrustes() %>%
  stack() #visualize hindwings
```

```{r,EFA --> PCA}
forewings %>%
  coo_interpolate(fore.min) %>% 
   coo_align()  %>%
  fgProcrustes() %>% 
  efourier(norm=FALSE) 

hindwings %>% 
   coo_interpolate(hind.min) %>% 
   coo_align()  %>%
  fgProcrustes() %>% 
  efourier(norm=FALSE) 
```

```{r, PCA}
forewing.pca <- forewings %>%
  coo_interpolate(fore.min) %>%
   coo_align()  %>%
  coo_slide(id=1) %>% 
  fgProcrustes() %>% 
  efourier(norm=FALSE) %>% 
  PCA()

hindwing.pca <-hindwings %>% 
   coo_interpolate(hind.min) %>% 
   coo_align()  %>%
   coo_slide(id=1) %>% 
  fgProcrustes() %>% 
  efourier(norm=FALSE) %>% 
  PCA()

hindwings %>% 
   coo_interpolate(hind.min) %>% 
   coo_align()  %>%
   coo_slide(id=1) %>% 
  fgProcrustes() %>% 
  stack

forewing.pca %>% 
  plot_PCA(title = "forewings")

hindwing.pca %>% 
  plot_PCA(title = "hindwings")

```

Comparative Analysis

```{r, Prepare for Comparative Analysis, include= FALSE}
library(ape)

lep.tree <- ape::read.tree("lep_tree2.tre")

plot(lep.tree,cex=0.1)

lep.tree <- ladderize(lep.tree)
plot(lep.tree,cex=0.1)

lep.tree$tip.label <- gsub("_"," ",lep.tree$tip.label)
basename(names(outs))[1:5]
lep.sp <- read_csv("lep_image_data.csv")
head(lep.sp)
head(lep.sp$identifier)

#
out.data <- tibble(xy.file=basename(names(outs))) %>% 
  mutate(identifier=gsub("XY_|_hindwing|_forewing|.txt","",xy.file)) %>% 
  left_join(lep.sp)

hindwing.pca2 <-  tibble(xy.file=basename(rownames(hindwing.pca$x)),PC1=hindwing.pca$x[,1],PC2=hindwing.pca$x[,2]) %>% 
  left_join(out.data)

forewing.pca2 <-  tibble(xy.file=basename(rownames(forewing.pca$x)),PC1=forewing.pca$x[,1],PC2=forewing.pca$x[,2])%>% 
  left_join(out.data)

```

Evolutionary Rates

```{r, }
drops <- lep.tree$tip.label[!lep.tree$tip.label%in%unique(out.data$species)]

lep.tree2 <- drop.tip(lep.tree,drops)

plot(lep.tree2,cex=0.5)

#PC1s
hind.pc1 <- hindwing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull

names(hind.pc1) <-  hindwing.pca2%>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(species)

fore.pc1 <- forewing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
   group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(PC1)

names(fore.pc1) <-  forewing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
     group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(species)

#PC2s
hind.pc2 <- hindwing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(PC2)

names(hind.pc2) <-  hindwing.pca2%>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>%
  summarize(PC2=mean(PC2)) %>% 
  pull(species)

fore.pc2 <- forewing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
   group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(PC2)

names(fore.pc2) <-  forewing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
     group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(species)
```

```{r, load, include = FALSE}
library(phytools)
forePC1.BM<-brownie.lite(lep.tree2,fore.pc1*10)
hindPC1.BM<-brownie.lite(lep.tree2,hind.pc1*10)

forePC2.BM<-brownie.lite(lep.tree2,fore.pc2*10)
hindPC2.BM<-brownie.lite(lep.tree2,hind.pc2*10)

```

```{r, }
library(RRphylo)
hindPC1.RR <- RRphylo(tree=lep.tree2,y=hind.pc1)
plot(lep.tree2)
nodelabels(node = as.numeric(rownames(hindPC1.SS$single.clades)),text = rownames(hindPC1.SS$single.clades))

hindPC1.plot <- plotShift(RR=hindPC1.RR,SS=hindPC1.SS)

forePC1.plot <- plotShift(RR=hindPC1.RR,SS=hindPC1.SS)
hindPC1.plot$plotClades()

```

Shape Evaluation Correlation

```{r, load libraries and define funtion, include= FALSE}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("ggtree")

library(ggtree)
library(wesanderson)

plot_SS <- function(tre=NULL,SS=NULL,tax=NULL){
  

  nodes <- as.numeric(rownames(SS$single.clades))
  
  pal <- wes_palette("Zissou1",n=length(nodes))
  sp <- list()
  for(i in nodes){
    sp.i <- extract.clade(tre,i)$tip.label
    
    #print(head(tax))
    sub.names <- lapply(tax,function(x) x[x%in%sp.i]) 
    
    in.clades <- lapply(sub.names,function(x) length(x)>0) 
    all.of.clade <- lapply(sub.names,function(x) all(sapply(sp.i,function(z) z%in%x))) 
    
    high.clade <- names(sub.names)[last(which(all.of.clade==T))]
    all.clades <- names(sub.names)[which(in.clades==T)]
    crown <- ""
    if(high.clade!=last(names(sub.names))) crown <- "crown-"
    
    sub.clades <- NULL
    if(length(grepl("oidea",all.clades))>0) sub.clades <- all.clades[grepl("oidea",all.clades)]

    high.clade2 <- paste0(crown,high.clade,": ",paste0(sub.clades,collapse = "+"))
    sp[[paste0(i)]] <- tibble(n=i,species=sp.i,clade=high.clade2)
    
  }

  
  d <- do.call(rbind,sp)%>% 
    rename(label=species) 
  
  d2<- d %>% rename(clade_name=clade) 
  
  p <- ggtree(tre)+ scale_y_reverse()
  
  p$data <- p$data %>% left_join(d) %>% left_join(tibble(node=nodes,SS$single.clades) %>% mutate(shift=ifelse(rate.difference>0,"+","-")))
  
  p <-  p+geom_tiplab(aes(col=clade),geom="text",size=1.2)+
    geom_cladelab(data=d2,mapping=aes(node=n,col=clade_name,label=clade_name),offset=1,size=1.5)+
    geom_hilight(data=d2,mapping = aes(node = n,fill=clade_name),alpha = 0.01)+
    scale_fill_manual(values = pal)+
    scale_color_manual(values = pal)+
    theme(legend.position = "none")+geom_nodepoint(mapping=aes(subset = shift =="-"), size=5, shape=25,fill='blue',color='blue',alpha=0.7)+
    geom_nodepoint(mapping=aes(subset = shift =="+"), size=5, shape=24, fill='red',color='red',alpha=0.7)
  p <- p+xlim(NA,6)
  res <- tibble(n=nodes,SS$single.clades) %>% left_join(d %>% select(n,clade) %>% unique)
  
  return(list(plot=p,res=res))
  
}

```

```{r, plot shift in evolutionary rates}
tax.names <- readRDS("Lep_classification.RDS")

hindPC1.res <- plot_SS(lep.tree2,hindPC1.SS,tax = tax.names)

hindPC1.res$plot

```

Shape Evolution Correlation

```{r}
hindPC1.pic <- pic(hind.pc1,phy = lep.tree2)
forePC1.pic <- pic(fore.pc1,phy = lep.tree2)


PC1.pic <- tibble(
  hind=hindPC1.pic,
  fore=forePC1.pic
)

PC1.pic %>% 
  ggplot(aes(x=fore,y=hind))+geom_point()+geom_smooth(method="lm")

summary(lm(hind~fore,PC1.pic))

```

#Discussion

#Author Contributions

Justin - Wing Tracing, PCA Analysis, Results, Discussion

#References
